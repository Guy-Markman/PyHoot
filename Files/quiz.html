<!doctype html>
<html>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>PyHoot!</title>
        <script src="util.js"></script>
        <script>
            var PLAYERS_IN_LINE = 3;
            var state = "Registration";
            var timer = window.setInterval(getnames, 1000);
            var number_of_questions = null;

            function switch_screens() {
                switch (state) {
                    case "Opening":
                        start = "Registration";
                        break;
                    case "Answer":
                        start = "Question";
                        break;
                    case "Question":
                        //If something was loaded to ans it means that I already did one question
                        if (document.getElementById("ans").innerHTML) {
                            start = "Leaderboard";
                        } else {
                            start = "Opening";
                        }
                        break;
                    case "Leaderboard":
                        start = "Answer";
                        break;
                    case "Finish":
                        start = "Leaderboard";
                        break;
                }
                var state_style_display = document.getElementById(state).style.display;
                var start_style_display = document.getElementById(start).style.display;
                state_style_display = [start_style_display, start_style_display = state_style_display][0];
                document.getElementById(state).style.display = state_style_display;
                document.getElementById(start).style.display = start_style_display;
            }

            function get_join_number() {
                xmlrequest(
                    "get_join_number",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            xmlDoc = parse_xml_from_string(this.responseText);
                            console.log(xmlDoc);
                            extranal = xmlDoc;
                            document.getElementById("join_number").innerHTML = xmlDoc.getElementsByTagName("join_number")[0].textContent;
                        }
                    }
                );
            }

            function getnames() {
                xmlrequest("getnames", function() {
                    if (this.readyState == 4 && this.status == 200) {
                        xmlDoc = parse_xml_from_string(this.responseText);
                        players = xmlDoc.getElementsByTagName("player");
                        string_players = "";
                        for (i = 0; i < players.length; i++) {
                            string_players += players[i].getAttribute("name");
                            if (i % PLAYERS_IN_LINE === 0 && i !== 0) {
                                string_players += "<br/>";
                            }
                        }
                        document.getElementById("names").innerHTML = string_players;
                    }
                });
            }

            //continue only if at least one user is online
            function check_moveable() {
                if (document.getElementById("names").innerHTML.length > 0) {
                    change_Registeration_Opening();
                }
            }

            function change_Registeration_Opening() {
                state = "Opening";
                set_timer("5");
                clearInterval(timer);
                timer = window.setInterval(check_timer_change, 1000);
                getinfo();
                switch_screens();
            }

            function check_move_question() {
                xmlrequest("check_move_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            if (this.responseText == "True") {
                                clearInterval(timer);
                                change_Question_Answer();
                            }
                        }
                    }
                );
            }

            function change_Question_Answer() {
                xmlrequest("get_answers",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            xmlrequest("order_move_all_not_answered", null);
                            var ans = this.responseText.split(", ");
                            answer_html = document.getElementById("ans");
                            answer_html.innerHTML = "";
                            for (var i = 0; i < ans.length; i++) {
                                answer_html.innerHTML += document.getElementById(ans[i] + "_answer").innerHTML + "<br />";
                            }
                            state = "Answer";
                            switch_screens();
                            clearInterval(timer);
                            set_timer("5");
                            timer = window.setInterval(check_timer_change, 1000);
                        }
                    }
                );
            }

            function change_Opening_Question() {
                order_move_all_players();
                xmlrequest("start_question", null);
                state = "Question";
                switch_screens();
            }

            function change_Answer_Leaderboard() {
                xmlrequest("get_xml_leaderboard",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText, "text/xml");
                            leaderboard = document.getElementById("Leaderboard");
                            //TODO: Move as much as I can into the HTML page
                            var list_players = xmlDoc.getElementsByTagName("Player");
                            var lb = "<table>";
                            for (i = 0; i < list_players.length; i++) {
                                player = list_players[i];
                                lb += "<tr>" +
                                    "   <td>" +
                                    player.getAttribute("name") +
                                    "   </td>" +
                                    "   <td>" +
                                    player.getAttribute("score") +
                                    "   </td>" +
                                    "</tr>";
                            }
                            lb += "</table>";
                            document.getElementById("Leaderboard_content").innerHTML = lb;
                            order_move_all_players();
                            state = "Leaderboard";
                            switch_screens();
                            set_timer("5");
                            timer = window.setInterval(check_timer_change, 1000);
                        }
                    }
                );
            }

            function getinfo() {
                xmlrequest("get_information",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText,
                                "text/xml");
                            quiz = xmlDoc.getElementsByTagName("Quiz")[0];
                            document.getElementById("quiz_name").innerHTML =
                                quiz.getAttribute("name");
                            document.getElementById("number_questions").innerHTML =
                                quiz.getAttribute("number_of_questions") + " questions";
                        }
                    }
                );
            }

            function get_winner() {
                var oTable = document.getElementById("Leaderboard_content").getElementsByTagName("table")[0];

                var oCells = oTable.rows.item(0).cells;

                document.getElementById("Finish_name").innerHTML = oCells.item(0).innerHTML;
                document.getElementById("Finish_score").innerHTML = oCells.item(1).innerHTML;
            }

            function order_move_all_players() {
                xmlrequest("order_move_all_players", null);
            }

            function set_timer(new_time) {
                xmlrequest("set_timer_change?new_time=" + new_time, null);
            }

            function check_timer_change() {
                xmlrequest("check_timer_change",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            if (this.responseText == "True") {
                                clearInterval(timer);
                                if (state == "Opening") {
                                    move_to_next_question();
                                }
                                if (state == "Answer") {
                                    change_Answer_Leaderboard();
                                }
                                if (state == "Leaderboard") {
                                    if (number_of_questions > -1) {
                                        move_to_next_question();
                                    } else {
                                        xmlrequest("set_ended?new=True", null);
                                        order_move_all_players();
                                        state = "Finish";
                                        // WIP
                                    }
                                }
                            }
                        }
                    }
                );
            }

            function move_to_next_question() {
                xmlrequest("move_to_next_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            number_of_questions = parseInt(this.responseText);
                            if (number_of_questions >= 0) {
                                get_question();
                            } else {
                                state = "Finish";
                                get_winner();
                                switch_screens();
                                clearInterval(timer);
                            }
                        }
                    }
                );
            }


            function get_question() {
                xmlrequest("get_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText,
                                "text/xml");
                            question = xmlDoc.getElementsByTagName("Question")[0];
                            set_timer(question.getAttribute("duration"));
                            timer = window.setInterval(check_move_question, 1000);
                            document.getElementById("question_title").innerHTML =
                                question.childNodes[1].textContent;
                            var questionsID = ["A_answer", "B_answer", "C_answer", "D_answer"];
                            for (i = 0; i < 4; i++) {
                                document.getElementById(questionsID[i]).innerHTML =
                                    xmlDoc.getElementsByTagName("Answer")[i].textContent;
                            }
                            state = "Question";
                            change_Opening_Question();
                        }
                    }
                );
            }
        </script>
    </head>

    <body onload="get_join_number();">
        <center>
            <div id="Registration" style="display:inline">
                <font size="7">Now you can join the Game!<br /></font>
                <font size="7" id="join_number"></font>
                <p id="br1">
                    <br /><br />Connected players
                </p>
                <font size="4" id="names">
                </font>
                <p id="br2">
                    <br /><br />
                </p>
                <input type="button" id="Start_playing" value="Start playing" onclick="check_moveable()">
            </div>
            <div id="Opening" style="display:none">
                <font size="7" id="quiz_name">
                </font>
                <br /><br />
                <font size="4" id="number_questions">
                </font>
            </div>
            <div id="Question" style="display:none">
                <p id="question_title">
                </p>
                <table style="width:20%">
                    <tr>
                        <td id="A_answer" style="text-align:left">
                        </td>
                        <td id="B_answer" style="text-align:right">
                        </td>
                    </tr>
                    <tr>
                        <td id="C_answer" style="text-align:left">
                        </td>
                        <td id="D_answer" style="text-align:right">
                        </td>
                    </tr>
                </table>
            </div>
            <div id="Answer" style="display:none">
                <font size="7">The right answer/s is/are:<br /></font>
                <font size="6" id="ans"></font>
            </div>
            <div id="Leaderboard" style="display:none">
                <font size="7">Top players</font><br />
                <table>
                    <tr>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                </table>
                <div id="Leaderboard_content">
                </div>
            </div>
            <div id="Finish" style="display:none">
                <font size="7">And this winner is... <br /></font>
                <font size="7" id="Finish_name"></font>
                <font size="6"><br />with </font>
                <font size="7" id="Finish_score"></font>
                <font size="6">points!</font>
            </div>
        </center>
    </body>

</html>
