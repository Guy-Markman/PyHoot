<!doctype html>
<html>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>PyHoot!</title>
        <script>
            var state = "Registeration";
            var timer = window.setInterval(getnames, 1000);

            function xmlrequest(url, state_change) {
                var xhttp = new XMLHttpRequest();
                if (state_change !== null) {
                    xhttp.onreadystatechange = state_change;
                }
                xhttp.open("GET", url, true);
                xhttp.send();
            }

            function setInnerHTML(url, id) {
                xmlrequest(url,
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            document.getElementById(id).innerHTML =
                                this.responseText;
                        }
                    }
                );
            }

            function getnames() {
                setInnerHTML("getnames", "names", true);
            }

            //continue only if at least one user is online
            function check_moveable() {
                if (document.getElementById("names").innerHTML.length > 0) {
                    change_Registeration_Opening();
                }
            }

            function change_Registeration_Opening() {
                state = "Opening";
                set_timer("5");
                clearInterval(timer);
                timer = window.setInterval(check_timer_change, 1000);
                getinfo();
                document.getElementById('Registration').style.display = "none";
                document.getElementById('Opening').style.display = "inline";

            }

            function check_move_question() {
                xmlrequest("check_move_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            if (this.responseText == "True") {
                                clearInterval(timer);
                                change_Question_Answer();
                            }
                        }
                    }
                );
            }

            function change_Question_Answer() {
                xmlrequest("get_answers",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            xmlrequest("order_move_all_not_answered", null);
                            var ans = this.responseText.split(", ");
                            answer_html = document.getElementById("ans");
                            answer_html.innerHTML = "";
                            for (var i = 0; i < ans.length; i++) {
                                answer_html.innerHTML += document.getElementById(ans[i] + "_answer").innerHTML + "<br />";
                            }
                            document.getElementById("Question").style.display = "none";
                            document.getElementById("Answer").style.display = "inline";
                            clearInterval(timer);
                            state = "Answer";
                            set_timer("3");
                            timer = window.setInterval(check_timer_change, 1000);
                        }
                    }
                );
            }

            function change_Opening_Question() {
                order_move_all_players();
                xmlrequest("start_question", null);
                document.getElementById('Opening').style.display = "none";
                document.getElementById('Question').style.display = "inline";
            }

            function change_Answer_Leaderboard() {
                xmlrequest("get_xml_leaderboard",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText, "text/xml");
                            leaderboard = document.getElementById("Leaderboard");
                            //TODO: Move as much as I can into the HTML page
                            var list_players = xmlDoc.getElementsByTagName("Player");
                            var lb = "<table>";
                            for (i = 0; i < list_players.length; i++) {
                                player = list_players[i];
                                lb += "<tr>" +
                                    "   <td>" +
                                    player.getAttribute("name") +
                                    "   </td>" +
                                    "   <td>" +
                                    player.getAttribute("score") +
                                    "   </td>" +
                                    "</tr>";
                            }
                            lb += "</table>";
                            document.getElementById("Leaderboard_content").innerHTML = lb;
                            order_move_all_players();
                            document.getElementById("Answer").style.display = "none";
                            document.getElementById("Leaderboard").style.display = "inline";
                        }
                    }
                );
            }

            function getinfo() {
                xmlrequest("get_information",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText,
                                "text/xml");
                            quiz = xmlDoc.getElementsByTagName("Quiz")[0];
                            document.getElementById("quiz_name").innerHTML =
                                quiz.getAttribute("name");
                            document.getElementById("number_questions").innerHTML =
                                quiz.getAttribute("number_of_questions") + " questions";
                        }
                    }
                );
            }

            function order_move_all_players() {
                xmlrequest("order_move_all_players", null);
            }

            function set_timer(new_time) {
                xmlrequest("set_timer_change?new_time=" + new_time, null);
            }

            function check_timer_change() {
                xmlrequest("check_timer_change",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            if (this.responseText == "True") {
                                clearInterval(timer);
                                if (state == "Opening") {
                                    move_to_next_question();
                                }
                                if (state == "Answer") {
                                    change_Answer_Leaderboard();
                                }
                            }
                        }
                    }
                );
            }

            function move_to_next_question() {
                xmlrequest("move_to_next_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            if (parseInt(this.responseText) >= 0) {
                                get_question();
                            } else {
                                state = "finish";
                            }
                        }
                    }
                );
            }


            function get_question() {
                xmlrequest("get_question",
                    function() {
                        if (this.readyState == 4 && this.status == 200) {
                            parser = new DOMParser();
                            xmlDoc = parser.parseFromString(this.responseText,
                                "text/xml");
                            question = xmlDoc.getElementsByTagName("Question")[0];
                            set_timer(question.getAttribute("duration"));
                            timer = window.setInterval(check_move_question, 1000);
                            document.getElementById("question_title").innerHTML =
                                question.childNodes[1].firstChild.nodeValue;
                            var questionsID = ["A_answer", "B_answer", "C_answer", "D_answer"];
                            for (i = 0; i < 4; i++) {
                                document.getElementById(questionsID[i]).innerHTML =
                                    xmlDoc.getElementsByTagName("Answer")[i].childNodes[1].firstChild.nodeValue;
                            }
                            state = "Question";
                            change_Opening_Question();
                        }

                    }
                );
            }
        </script>
    </head>

    <body onload="setInnerHTML('get_join_number', 'join_number');">
        <center>
            <div id="Registration" style="display:inline">
                <font size="7">Now you can join the Game!<br /></font>
                <font size="7" id="join_number"></font>
                <p id="br1">
                    <br /><br />Connected players
                </p>
                <font size="4" id="names">
                </font>
                <p id="br2">
                    <br /><br />
                </p>
                <input type="button" id="Start_playing" value="Start playing" onclick="check_moveable()">
            </div>
            <div id="Opening" style="display:none">
                <font size="7" id="quiz_name">
                </font>
                <br /><br />
                <font size="4" id="number_questions">
                </font>
            </div>
            <div id="Question" style="display:none">
                <p id="question_title">
                </p>
                <table align="center" style="width:20%">
                    <tr>
                        <td>
                            <p id="A_answer">
                            </p>
                        </td>
                        <td>
                            <p id="B_answer">
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <p id="C_answer">
                            </p>
                        </td>
                        <td>
                            <p id="D_answer">
                            </p>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="Answer" style="display:none">
                <font size="7">The right answer/s is/are:<br /></font>
                <font size="6" id="ans"></font>
            </div>
            <div id="Leaderboard" style="display:none">
                <font size="7">Top players</font><br/>
                <table>
                    <tr>
                        <th>Player</th>
                        <th>Score</th>
                    </tr>
                </table>
                <div id="Leaderboard_content">
                </div>
            </div>
        </center>
    </body>

</html>
