<!doctype html>
<html>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>PyHoot!</title>
        <script>
            var state = "Registeration";
            var timer = window.setInterval(function() {
                getnames();
            }, 1000);

            function setInnerHTML(url, id) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById(id).innerHTML =
                            this.responseText;
                    }
                };
                xhttp.open("GET", url, true);
                xhttp.send();
                return false;
            }


            function getnames() {
                setInnerHTML("getnames", "names", true);
            }

            //continue only if at least one user is online
            function check_moveable() {
                if (document.getElementById("names").innerHTML.length > 0) {
                    changeDiv1();
                }
            }

            function changeDiv1() {
                state = "Opening";
                clearInterval(timer);
                order_move_all_players();
                set_timer("5");
                timer = window.setInterval(function() {
                    check_timer_change();
                }, 1000);
                getinfo();
                document.getElementById('part1').style.display = "none";
                document.getElementById('part2').style.display = "inline";

            }

            function changeDiv2() {
                document.getElementById('part2').style.display = "none";
                document.getElementById('part3').style.display = "inline";
            }

            function getinfo() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(this.responseText,
                            "text/xml");
                        quiz = xmlDoc.getElementsByTagName("Quiz")[0];
                        document.getElementById("quiz_name").innerHTML =
                            quiz.getAttribute("name");
                        document.getElementById("number_questions").innerHTML =
                            quiz.getAttribute("number_of_questions") + " questions";
                    }
                };
                xhttp.open("GET", "get_information", true);
                xhttp.send();
            }

            function order_move_all_players() {
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "order_move_all_players", true);
                xhttp.send();
            }

            function set_timer(new_time) {
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "set_timer_change?new_time=" + new_time);
                xhttp.send();
            }

            function check_timer_change() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        if (this.responseText == "True") {
                            if (state == "Opening") {
                                clearInterval(timer);
                                move_to_next_question();
                            }
                        }
                    }
                };
                xhttp.open("GET", "check_timer_change", true);
                xhttp.send();
            }

            function move_to_next_question() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        if (parseInt(this.responseText) >= 0) {
                            get_question();
                        }
                    }
                };
                xhttp.open("GET", "move_to_next_question", true);
                xhttp.send();
            }


            function get_question() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(this.responseText,
                            "text/xml");
                        document.getElementById("question_title").innerHTML =
                            xmlDoc.getElementsByTagName("Question")[0].childNodes[1].firstChild.nodeValue;

                        var questionsID = ["A_answer", "B_answer", "C_answer", "D_answer"];
                        for (i = 0; i < 4; i++) {
                            document.getElementById(questionsID[i]).innerHTML =
                                xmlDoc.getElementsByTagName("Answer")[i].childNodes[1].firstChild.nodeValue;
                        }
                        state = "Question";
                        changeDiv2();
                    }

                };
                xhttp.open("GET", "get_question", true);
                xhttp.send();
            }

        </script>
    </head>

    <body onload="setInnerHTML('get_join_number', 'join_number');">
        <center>
            <div id="part1" style="display:inline">
                <font size="7">Now you can join the Game!<br /></font>
                <font size="7" id="join_number"></font>
                <p id="br1">
                    <br /><br />Connected players
                </p>
                <font size="4" id="names">
                </font>
                <p id="br2">
                    <br /><br />
                </p>
                <input type="button" id="Start_playing" value="Start playing" onclick="check_moveable()">
            </div>
            <div id="part2" style="display:none">
                <font size="7" id="quiz_name">
                </font>
                <br /><br />
                <font size="4" id="number_questions">
                </font>
            </div>
            <div id="part3" style="display:none">
                <p id="question_title">
                </p>
                <table style="width:0%">
                    <tr>
                        <td>
                            <p id="A_answer">
                            </p>
                        </td>
                        <td>
                            <p id="B_answer">
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <p id="C_answer">
                            </p>
                        </td>
                        <td>
                            <p id="D_answer">
                            </p>
                        </td>
                    </tr>
                </table>
            </div>
        </center>
    </body>

</html>
